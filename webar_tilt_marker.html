<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>WebAR 傾き計測（マーカー式）</title>
  <!-- A-Frame & AR.js (A-Frame build) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ar.js@3.4.5/aframe/build/aframe-ar.js"></script>
  <style>
    body { margin: 0; overflow: hidden; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; }
    #hud {
      position: fixed; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.45); color: #fff; padding: 10px 12px; line-height: 1.4;
      font-size: 14px; z-index: 2;
    }
    #hud .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    #hud button {
      font-size: 14px; padding: 6px 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.15); color: #fff;
    }
    #hud .badge { display:inline-block; padding: 2px 6px; border-radius: 999px; background:#1e90ff; font-weight:700; }
    #tip {
      position: fixed; top: 8px; left: 8px; right: 8px; color: #fff; z-index: 2;
      background: rgba(0,0,0,0.35); padding: 8px 10px; border-radius: 8px; font-size: 13px;
    }
    a { color: #8ad7ff; }
  </style>
</head>
<body>
  <div id="tip">
    使い方：マーカー（<span class="badge">hiro</span>）を印刷して机に置き、カメラを向けます。<br/>
    マーカー平面上を<strong>2回タップ</strong>すると線が引かれ、<strong>角度</strong>が表示されます（基準はマーカーの横方向=0°）。
  </div>

  <a-scene
    embedded
    renderer="colorManagement: true; physicallyCorrectLights: true;"
    arjs="sourceType: webcam; debugUIEnabled: false;"
    cursor="rayOrigin: mouse; fuse: false"
    raycaster="objects: .clickable"
  >
    <a-entity camera></a-entity>

    <!-- AR.js preset marker 'hiro' -->
    <a-marker id="marker" preset="hiro">
      <!-- invisible plane to receive taps -->
      <a-plane id="tapPlane" class="clickable"
               rotation="-90 0 0" position="0 0 0"
               width="4" height="4"
               material="opacity: 0.0; transparent: true">
      </a-plane>

      <!-- dynamic lines -->
      <a-entity id="line" line="start: 0 0 0; end: 0 0 0; color: #00FFFF"></a-entity>
      <a-entity id="axis" line="start: 0 0 0; end: 0 0 0; color: #00FF00"></a-entity>
    </a-marker>

    <!-- required for AR.js -->
    <a-entity camera></a-entity>
  </a-scene>

  <div id="hud">
    <div class="row" style="margin-bottom:6px;">
      <button id="btn-undo">戻す</button>
      <button id="btn-clear">クリア</button>
      <button id="btn-snap">最寄り0°/90°にスナップ</button>
      <span id="status">待機中…</span>
    </div>
    <div id="readout">角度: -- °</div>
  </div>

  <script>
    const markerEl = document.querySelector('#marker');
    const planeEl  = document.querySelector('#tapPlane');
    const lineEl   = document.querySelector('#line');
    const axisEl   = document.querySelector('#axis');
    const statusEl = document.querySelector('#status');
    const readoutEl= document.querySelector('#readout');

    let pts = []; // markerローカル座標の点列（THREE.Vector3）
    let angleDeg = null;

    function updateLine() {
      if (pts.length < 1) {
        lineEl.setAttribute('line', 'start: 0 0 0; end: 0 0 0; color: #00FFFF');
        axisEl.setAttribute('line', 'start: 0 0 0; end: 0 0 0; color: #00FF00');
        readoutEl.textContent = '角度: -- °';
        return;
      }
      if (pts.length === 1) {
        readoutEl.textContent = '2点目をタップしてください…';
        return;
      }
      const p1 = pts[pts.length-2];
      const p2 = pts[pts.length-1];
      lineEl.setAttribute('line', `start: ${p1.x} ${p1.y} ${p1.z}; end: ${p2.x} ${p2.y} ${p2.z}; color: #00FFFF`);

      // マーカーのX軸（横）に対する角度
      const dx = p2.x - p1.x;
      const dy = p2.y - p1.y;
      angleDeg = Math.atan2(dy, dx) * 180 / Math.PI;
      angleDeg = ((angleDeg + 90) % 180 + 180) % 180 - 90; // [-90,90]

      const horizTilt = Math.abs(angleDeg);
      const vertTilt  = Math.min(Math.abs(angleDeg - 90), Math.abs(angleDeg + 90));
      const label = (horizTilt < vertTilt) ? '梁（水平系）' : '柱（垂直系）';
      readoutEl.innerHTML = `角度: <b>${angleDeg.toFixed(2)}°</b>　/　分類: <b>${label}</b>　（水平ズレ ${horizTilt.toFixed(2)}° / 垂直ズレ ${vertTilt.toFixed(2)}°）`;

      // 中点を通る水平の補助線（見やすさ用）
      const midx = (p1.x + p2.x)/2, midy = (p1.y + p2.y)/2, midz = (p1.z + p2.z)/2;
      const len = Math.hypot(dx, dy);
      const ax1 = new THREE.Vector3(midx - len/2, midy, midz);
      const ax2 = new THREE.Vector3(midx + len/2, midy, midz);
      axisEl.setAttribute('line', `start: ${ax1.x} ${ax1.y} ${ax1.z}; end: ${ax2.x} ${ax2.y} ${ax2.z}; color: #00FF00`);
    }

    function worldToMarkerLocal(worldVec3) {
      const p = worldVec3.clone();
      markerEl.object3D.worldToLocal(p);
      return p;
    }

    planeEl.addEventListener('click', (e) => {
      if (!e.detail || !e.detail.intersection) {
        statusEl.textContent = 'タップは検知したが交差が不明です（別の場所をタップ）';
        return;
      }
      const pWorld = e.detail.intersection.point;
      const pLocal = worldToMarkerLocal(pWorld);
      pts.push(pLocal);
      statusEl.textContent = `点 ${pts.length}: (${pLocal.x.toFixed(3)}, ${pLocal.y.toFixed(3)})`;
      updateLine();
    });

    document.getElementById('btn-undo').addEventListener('click', () => {
      if (pts.length > 0) pts.pop();
      updateLine();
      statusEl.textContent = '1つ戻しました';
    });
    document.getElementById('btn-clear').addEventListener('click', () => {
      pts = [];
      updateLine();
      statusEl.textContent = 'クリアしました';
    });
    document.getElementById('btn-snap').addEventListener('click', () => {
      if (angleDeg == null || pts.length < 2) return;
      const p1 = pts[pts.length-2];
      const p2 = pts[pts.length-1];
      const target = (Math.abs(angleDeg) <= 45) ? 0 : 90; // 近い方
      const rad = target * Math.PI / 180;
      const len = Math.hypot(p2.x - p1.x, p2.y - p1.y);
      const newX = p1.x + len * Math.cos(rad);
      const newY = p1.y + len * Math.sin(rad);
      pts[pts.length-1] = new THREE.Vector3(newX, newY, p2.z);
      updateLine();
      statusEl.textContent = `最寄り ${target}° にスナップしました`;
    });

    markerEl.addEventListener('markerFound', () => statusEl.textContent = 'マーカー検出！ 2点タップで計測してください');
    markerEl.addEventListener('markerLost',  () => statusEl.textContent = 'マーカーが見失われました…');
  </script>

  <!-- Tips -->
  <div style="position: fixed; right: 8px; top: 56px; z-index: 2; background: rgba(0,0,0,0.35); color:#fff; padding:6px 8px; border-radius:8px; font-size:12px;">
    <div>📄 <b>hiro マーカー</b>を印刷（A4に約5〜10cm角でOK）。<br/>検索ワード：<i>hiro marker pdf</i></div>
    <div style="margin-top:6px;">💡 <b>ロール補正不要</b>：マーカー座標が基準（横=0°/縦=±90°）。</div>
  </div>
</body>
</html>
